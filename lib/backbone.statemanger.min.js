// Backbone.Statemanager, v1.0.0-rc1
// Copyright (c)2013 Patrick Camacho and Mark Roseboom, Crashlytics
// Distributed under MIT license
// http://github.com/crashlytics/backbone.statemanager

var StateManager;StateManager=function(e,t,n){StateManager={},e.StateManager=StateManager,StateManager.regExpStateConversion=function(e){return e=e.replace(/[-[\]{}()+?.,\\^$|#\s]/g,"\\$&").replace(/:\w+/g,"([^/]+)").replace(/\*\w+/g,"(.*?)"),new RegExp("^"+e+"$")},StateManager.addStateManager=function(n,r){var i,s;r==null&&(r={}),n||new Error("Target must be defined"),s=t.isFunction(n.states)?n.states():n.states,s=StateManager.bindStates(n,s),i=new e.StateManager.Manager(s,r),t.extend(n,{states:s,stateManager:i,triggerState:function(){return i.triggerState.apply(i,arguments)},getCurrentStateName:function(){return i.getCurrentStateName()}});if(r.initialize!==!1)return n.stateManager.initialize(r)},StateManager.bindStates=function(e,n){return n=t.clone(n),t.each(n,function(n,r){return t.each(["enter","exit"],function(r){if(n[r])return n[r]=t.bind(n[r],e)}),t.each(n.transitions(function(r,i){return n[i]=t.bind(r,e)}))}),n};var r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};StateManager.Transition=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return i(n,e),n.prototype.idAttribute=name,n.prototype.validate=function(e){switch(!0){case!t.isString(e.pattern):return"Must have a pattern";case!t.isFunction(e.method):return"Must have a method";case!t.isRegExp(e.regExp):return"Must have a valid regexp"}},n.prototype.parse=function(e){var t;return(t=e.regExp)==null&&(e.regExp=StateManager.regExpStateConversion(e.pattern)),e},n}(e.Model);var r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};StateManager.Transitions=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return i(n,e),n.prototype.model=StateManager.Transition,n.prototype.matchTransitions=function(e,t){return this.filter(function(n){return n.get("type")===e&&n.get("regExp").test(t)!==n.get("inverse")})},n.prototype.parse=function(e){var n,r,i;r=[];if(t.isObject(e))for(n in e)i=e[n],r.push({pattern:n,method:i});return r},n}(e.Collection);var r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};StateManager.State=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return i(n,e),n.prototype.idAttribute="pattern",n.prototype.validate=function(e,n){switch(!0){case!t.isString(e.pattern):return"Must have a pattern";case!e.transitions instanceof StateManager.Transitions:return"Transitions must be a valid collection";case!t.isRegExp(e.regExp):return"Must have a valid regexp";case e.enter&&!t.isFunction(e.enter):return"Must have a valid enter method";case e.exit&&!t.isFunction(e.exit):return"Must have a valid exit method"}},n.prototype.matchTransitions=function(e,n){return t.pluck(this.get("transitions").matchTransitions(e,n),"method")},n.prototype.parse=function(e){var t;return e.transitions=new StateManager.Transitions(e.transitions),(t=e.regExp)==null&&(e.regExp=StateManager.regExpStateConversion(e.pattern)),e},n}(e.Model);var r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};return StateManager.States=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,e),t.prototype.model=StateManager.State,t.prototype.findInitial=function(){return this.find(function(e){return!!e.get("initial")})},t.prototype.match=function(e){return this.find(function(t){return t.get("regExp").match(e)})},t}(e.Collection),StateManager.Manager=function(){function e(e,t){var n;this.options=t!=null?t:{},this.states=new StateManager.States(e,this.options),(n=this.initialize)!=null&&n.apply(this,arguments)}return e.prototype.addState=function(e,n){return n==null&&(n={}),this.states.add(t.extend(n,{pattern:e}))},e.prototype.removeState=function(e){var t;return(t=this.states.get(e))!=null?t.destroy():void 0},e.prototype.triggerState=function(e,n){var r;n==null&&(n={});if(r=this.getCurrentStateName()!==name||n.reEnter)return this.exitState(r,t.extend({},n,{newStateName:e})),this.enterState(e,t.extend({},n,{prevStateName:r}))},e.prototype.enterState=function(e,t){var n,r,i;t==null&&(t={});if(!e||!(r=this.states.match(e)))return;return n=t.prevStateName,this.trigger("before:enter:state",r,e,t),n&&this.executeStateTransitions("onBeforeEnterFrom",n,r,e,t),typeof (i=r.get("enter"))=="function"&&i(t),this.setCurrentStateName(e),n&&this.executeStateTransitions("onEnterFrom",n,r,e,t),this.trigger("enter:state",r,e,t)},e.prototype.exitState=function(e,t){var n,r,i;t==null&&(t={});if(!e||!(r=this.states.match(e)))return;return n=t.newStateName,this.trigger("before:exit:state",r,e,t),n&&this.executeStateTransitions("onBeforeExitTo",n,r,e,t),typeof (i=r.get("exit"))=="function"&&i(t),this.setCurrentStateName(null),n&&this.executeStateTransitions("onExitTo",n,r,e,t),this.trigger("exit:state",r,e,t)},e.prototype.executeStateTransitions=function(e,n,r,i,s){if(!n)return;return t.each(typeof r.matchTransitions=="function"?r.matchTransitions(e,n):void 0,function(e){return e(r,i,s)})},e.prototype.getCurrenStateName=function(){return this.currentStateName},e.prototype.setCurrentStateName=function(e){var t;t=this.currentStateName,this.currentStateName=e;if(this.name!==t)return this.trigger("change:currentStateName",t,e)},e.prototype.close=function(){return typeof this.beforeClose=="function"&&this.beforeClose(),this.exitState(this.getCurrenStateName()),typeof this.onClose=="function"?this.onClose():void 0},e}(),t.extend(StateManager.Manager,e.Events),StateManager}(Backbone,_,$||window.jQuery||window.Zepto||window.ender);